name: R-ETF Agent CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libudev-dev

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with: { java-version: '11', distribution: 'temurin' }

      - name: Set up Python 3.9 and install dependencies
        uses: actions/setup-python@v5
        with: { python-version: '3.9' }
      - run: pip install requests

      - name: Set up Node.js 20 and install dependencies
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm install --prefix ./node_ui

      - name: Set up Rust toolchain
        uses: actions-rs/toolchain@v1
        with: { toolchain: stable, override: true }

      - name: Build Rust and Java components
        run: |
          cargo build --release --manifest-path=rust_collector/Cargo.toml
          javac java_manager/AgentManager.java

      - name: Assemble Release Package
        run: |
          mkdir release
          cp rust_collector/target/release/rust_collector release/
          cp -r java_manager release/
          cp -r python_orchestrator release/
          cp -r node_ui release/
          cp test_harness.sh release/
          # Correctly remove source from the package
          rm -f release/java_manager/AgentManager.java

      - name: Upload Agent Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: retf-agent-linux-build
          path: release/

  integration-test:
    runs-on: ubuntu-latest
    needs: build-and-package
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libudev-dev netcat-openbsd

      - name: Set up all language runtimes
        uses: actions/setup-java@v4
        with: { java-version: '11', distribution: 'temurin' }
      - uses: actions/setup-python@v5
        with: { python-version: '3.9' }
      - run: pip install requests
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm install --prefix ./node_ui
      - uses: actions-rs/toolchain@v1
        with: { toolchain: stable, override: true }

      - name: Build all components for test
        run: |
          cargo build --release --manifest-path=rust_collector/Cargo.toml
          javac java_manager/AgentManager.java

      - name: Correct file paths in agent config
        run: |
          # This is the KEY FIX: We dynamically find the current path and update the config file
          WORKING_DIR=$(pwd)
          sed -i "s|/home/RETF_Agent|$WORKING_DIR|g" java_manager/agent.properties

      - name: Run agent and automated test
        run: |
          # Start agent in background, logging to a file
          sudo java -cp java_manager AgentManager &> agent_output.log &
          sleep 15

          # Run the test harness with sudo privileges
          sudo bash test_harness.sh
          sleep 15

          echo "--- AGENT LOGS ---"
          cat agent_output.log
          echo "--------------------"

      - name: Verify alerts were triggered
        run: |
          grep "System Information Discovery" agent_output.log
          grep "Script Execution from /tmp" agent_output.log
          grep "Suspicious Process Execution: Netcat" agent_output.log
          grep "Password File Modification" agent_output.log
          echo "âœ… SUCCESS: All expected alerts were found in the log file."
